<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Expense Tracker</title>
    <style>
        :root {
            --bg: #f4f5fa;
            --container-bg: rgba(255,255,255,0.97);
            --card-bg: #fff;
            --header-bg: linear-gradient(135deg, #667eea, #764ba2);
            --primary: #4f46e5;
            --secondary: #764ba2;
            --text: #1f2937;
            --muted: #6b7280;
        }
        [data-theme="dark"] {
            --bg: #191e2d;
            --container-bg: rgba(35,38,53,0.95);
            --card-bg: #22253a;
            --header-bg: linear-gradient(135deg, #292edc, #522274);
            --primary: #b8a9fa;
            --secondary: #c4a9ef;
            --text: #e6e6e6;
            --muted: #bdbdbd;
        }

        html, body {
            min-height: 100vh;
        }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: var(--bg);
            min-height: 100vh;
            padding: 10px;
            color: var(--text);
            transition: background 0.3s, color 0.3s;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: var(--container-bg);
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.07);
            overflow: hidden;
            animation: slideUp 0.5s ease-out;
            padding-top: 20px;
            padding-bottom: 20px;
        }
        @keyframes slideUp {
            from { opacity: 0; transform: translateY(30px);}
            to { opacity: 1; transform: translateY(0);}
        }
        .header {
            background: var(--header-bg);
            color: white;
            padding: 20px;
            text-align: center;
            margin: 0 20px;
            border-radius: 15px;
            margin-bottom: 20px;
            position: relative;
        }
        .header h1 {
            font-size: 2rem;
            margin-bottom: 10px;
            text-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }
        .theme-toggle {
            position: absolute;
            top: 20px;
            right: 20px;
            background: var(--card-bg);
            color: var(--primary);
            border: none;
            border-radius: 999px;
            padding: 8px 20px;
            font-size: 1rem;
            cursor: pointer;
            font-weight: 600;
            box-shadow: 0 2px 6px rgba(0,0,0,0.07);
            transition: background 0.2s, color 0.2s;
        }
        .theme-toggle:hover { background: var(--primary); color: #fff;}

        .tabs-container { margin-top: 0px;}
        .tab-buttons {
            display: flex;
            justify-content: space-around;
            background: #e0e7ff;
            border-radius: 10px 10px 0 0;
            overflow: hidden;
            margin: 0 20px;
            margin-top: 20px;
        }
        .tab-button {
            flex-grow: 1;
            padding: 15px 20px;
            border: none;
            background: transparent;
            cursor: pointer;
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--primary);
            transition: all 0.3s;
            border-bottom: 3px solid transparent;
        }
        .tab-button:hover { background: #c7d2fe;}
        .tab-button.active {
            background: var(--primary);
            color: white;
            border-bottom: 3px solid #f59e0b;
        }
        .tab-content { display: none; padding: 20px; background: var(--card-bg); border-radius: 0 0 20px 20px; min-height: 400px;}
        .tab-content.active {
            display: grid;
            grid-template-columns: 1fr;
            gap: 20px;
        }
        @media (min-width: 768px) { .tab-content.active {grid-template-columns: 1fr 1fr;}}
        @media (min-width: 1024px) { .tab-content.active {grid-template-columns: 1fr 1fr 1fr;}}

        .card {
            background: var(--card-bg);
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.06);
            border: 1px solid rgba(0,0,0,0.03);
            transition: background 0.3s, color 0.3s;
        }
        .card h2 { color: var(--primary); margin-bottom: 15px; font-size: 1.3rem; display: flex; align-items: center; gap: 10px;}
        .input-group { margin-bottom: 15px;}
        .input-group label { display: block; margin-bottom: 5px; color: var(--text); font-weight: 600; font-size: 0.9rem;}
        .input-group input, .input-group select, .input-group textarea {
            width: 100%; padding: 12px 15px; border: 2px solid #e5e7eb; border-radius: 10px; font-size: 1rem; transition: all 0.3s; background: #f9fafb; color: var(--text);
        }
        [data-theme="dark"] .input-group input,
        [data-theme="dark"] .input-group select,
        [data-theme="dark"] .input-group textarea { background: #191e2d; color: #fff; border-color: #3a3f51;}
        .input-group input:focus, .input-group select:focus, .input-group textarea:focus {
            outline: none; border-color: var(--primary); background: #fff; box-shadow: 0 0 0 3px rgba(79,70,229,0.08);
        }
        .radio-group { display: flex; gap: 20px; margin-top: 10px;}
        .radio-group label { display: flex; align-items: center; cursor: pointer; font-weight: normal;}
        .radio-group input[type="radio"] { width: auto; margin-right: 8px; transform: scale(1.2); accent-color: var(--primary);}
        .btn {
            background: var(--primary);
            color: white; border: none; padding: 12px 24px; border-radius: 10px; font-size: 1rem; font-weight: 600; cursor: pointer;
            transition: all 0.3s; width: 100%; margin-top: 10px;
        }
        .btn:hover { transform: translateY(-2px); box-shadow: 0 10px 20px rgba(79,70,229,0.13);}
        .btn:active { transform: translateY(0);}
        .btn:disabled { opacity: 0.6; cursor: not-allowed; background: #a0aec0; box-shadow: none; transform: none;}
        .btn-secondary { background: var(--secondary);}
        .btn-outline { background: none; border: 2px solid #ef4444; color: #ef4444; margin-top: 10px;}
        .btn-outline:hover { background: #ef4444; color: white;}
        .budget-summary { display: grid; grid-template-columns: 1fr; gap: 15px; margin-top: 15px;}
        @media (min-width: 480px) { .budget-summary {grid-template-columns: repeat(3,1fr);}}
        .budget-item { text-align: center; padding: 15px; border-radius: 10px; background: linear-gradient(135deg, #f3f4f6, #e5e7eb);}
        .budget-item.budget { background: linear-gradient(135deg, #dbeafe, #bfdbfe);}
        .budget-item.spent { background: linear-gradient(135deg, #fee2e2, #fecaca);}
        .budget-item.remaining { background: linear-gradient(135deg, #d1fae5, #a7f3d0);}
        .budget-item h3 { font-size: 0.9rem; color: var(--muted); margin-bottom: 5px;}
        .budget-item .amount { font-size: 1.5rem; font-weight: bold; color: var(--text);}
        .table-container { overflow-x: auto; margin-top: 15px; border-radius: 10px; border: 1px solid #e5e7eb; max-width: 100%;}
        table { width: 100%; border-collapse: collapse; font-size: 0.9rem;}
        th { background: var(--primary); color: white; padding: 12px 8px; text-align: left; font-weight: 600; white-space: nowrap;}
        td { padding: 12px 8px; border-bottom: 1px solid #e5e7eb; color: var(--text);}
        @media (max-width: 600px) {
            table { display: block; width: 100%;}
            thead { display: none;}
            tr { display: block; margin-bottom: 10px; border: 1px solid #e5e7eb; border-radius: 10px; background: var(--card-bg);}
            td { display: block; text-align: right; padding-left: 50%; position: relative; border-bottom: 1px dashed #e5e7eb;}
            td:last-child { border-bottom: none;}
            td::before { content: attr(data-label); position: absolute; left: 10px; width: calc(50% - 20px); text-align: left; font-weight: bold; color: var(--primary);}
        }
        tr:hover { background: #f9fafb;}
        .mobile-expense-card-container { display: grid; grid-template-columns: 1fr; gap: 15px;}
        .mobile-expense-card {
            background: var(--card-bg); border-radius: 10px; padding: 15px; box-shadow: 0 5px 15px rgba(0,0,0,0.05); border: 1px solid #e5e7eb; position: relative;
        }
        .mobile-expense-card-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; padding-bottom: 10px; border-bottom: 1px solid #e0e7ff;}
        .mobile-expense-card-header .category { font-weight: bold; color: var(--primary); font-size: 1.1rem;}
        .mobile-expense-card-header .amount { font-weight: bold; color: var(--text); font-size: 1.2rem;}
        .mobile-expense-card-body { display: grid; grid-template-columns: 1fr; gap: 8px;}
        .mobile-expense-card-field { display: flex; justify-content: space-between; font-size: 0.9rem;}
        .mobile-expense-card-field .label { color: var(--muted); font-weight: 500;}
        .mobile-expense-card-field .value { color: var(--text); text-align: right; word-break: break-word;}
        .mobile-expense-card-actions { margin-top: 15px; text-align: right;}
        .mobile-expense-card-actions .btn-danger { padding: 6px 12px; font-size: 0.8rem;}
        .download-buttons { display: flex; gap: 10px; flex-wrap: wrap; margin-top: 15px; justify-content: space-between;}
        .download-buttons .btn { flex: 1; min-width: unset; margin-top: 0;}
        /* Chart area */
        .chart-container { position: relative; margin: auto; height: 280px; width: 100%;}
        /* Budget Progress Bar */
        .budget-progress-bar { width: 100%; background-color: #e0e7ff; border-radius: 15px; height: 30px; overflow: hidden; position: relative; margin-top: 20px; margin-bottom: 15px;}
        .budget-progress-fill { height: 100%; width: 0%; background: linear-gradient(90deg, #9fe6b0, #7ee793); transition: width 0.5s; border-radius: 15px;}
        .budget-progress-text { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); color: var(--text); font-weight: bold; font-size: 0.95rem; text-shadow: 0 1px 2px rgba(255,255,255,0.5); white-space: nowrap;}
        .summary-tables { display: grid; grid-template-columns: 1fr; gap: 20px; grid-column: 1 / -1;}
        @media (min-width: 768px) { .summary-tables {grid-template-columns: 1fr 1fr;}}
        .top-list { list-style: none; padding: 0; margin-top: 10px;}
        .top-list li { display: flex; justify-content: space-between; align-items: center; padding: 10px 0; border-bottom: 1px dashed #e5e7eb; font-size: 0.95rem;}
        .top-list li:last-child { border-bottom: none;}
        .top-list .label { font-weight: 500; color: var(--text); flex: 2;}
        .top-list .value { font-weight: bold; color: var(--primary); text-align: right; flex: 1;}
        .top-list-header { display: flex; justify-content: space-between; font-weight: bold; padding-bottom: 8px; border-bottom: 2px solid #e0e7ff; margin-bottom: 5px; color: var(--muted); font-size: 0.9rem;}
        .top-list-header span { flex: 1;}
        .top-list-header span:first-child { flex: 2;}
        .top-list-header span:last-child { text-align: right; flex: 1;}
    </style>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
</head>
<body>
    <div class="container" id="appContent">
        <div class="header">
            <h1 id="headerTitle">💰 Expense Tracker</h1>
            <button class="theme-toggle" id="themeToggleBtn" onclick="toggleTheme()">🌙 Dark</button>
            <p id="currentMonthYear"></p>
            <p>Track your expenses and manage your budget efficiently</p>
        </div>
        <div class="tab-buttons">
            <button class="tab-button active" onclick="showTab('dashboardTab')">Dashboard</button>
            <button class="tab-button" onclick="showTab('summaryTab')">Summary</button>
            <button class="tab-button" onclick="showTab('searchTab')">Search</button>
        </div>

        <div id="dashboardTab" class="tab-content active">
            <div class="card">
                <h2><span class="icon">🎯</span> Set Monthly Budget</h2>
                <div class="input-group">
                    <label for="budgetAmount">Budget Amount (₹)</label>
                    <input type="number" id="budgetAmount" placeholder="Enter your monthly budget">
                </div>
                <div class="download-buttons">
                    <button class="btn" id="setBudgetBtn" onclick="setBudget(event)">Set Budget</button>
                    <button class="btn btn-outline" id="resetBudgetBtn" onclick="resetBudget()">Reset Budget</button>
                </div>
                <div class="budget-summary">
                    <div class="budget-item budget"><h3>Budget</h3><div class="amount" id="budgetDisplay">₹0</div></div>
                    <div class="budget-item spent"><h3>Total Spent</h3><div class="amount" id="totalSpent">₹0</div></div>
                    <div class="budget-item remaining"><h3>Remaining</h3><div class="amount" id="remaining">₹0</div></div>
                </div>
                <div class="budget-progress-bar">
                    <div class="budget-progress-fill" id="budgetProgressBarFill"></div>
                    <div class="budget-progress-text" id="budgetProgressBarText">0% Used</div>
                </div>
            </div>

            <div class="card">
                <h2><span class="icon">➕</span> Add Expense</h2>
                <div class="input-group">
                    <label>Owner</label>
                    <div class="radio-group">
                        <label><input type="radio" name="recordedBy" value="Akshay" checked> Akshay</label>
                        <label><input type="radio" name="recordedBy" value="Achal"> Achal</label>
                    </div>
                </div>
                <div class="input-group">
                    <label for="category">Category</label>
                    <select id="category">
                        <option value="Grocery">Grocery</option>
                        <option value="Bills">Bills</option>
                        <option value="Online shopping">Online shopping</option>
                        <option value="Travelling">Travelling</option>
                        <option value="Food">Food</option>
                        <option value="Medical expenses">Medical expenses</option>
                        <option value="Debt">Debt</option>
                        <option value="Petrol">Petrol</option>
                        <option value="Home expenses other than grocery">Home expenses other than grocery</option>
                        <option value="Maintenance">Maintenance</option>
                        <option value="EMI">EMI</option>
                        <option value="Investment">Investment</option>
                        <option value="Entertainment">Entertainment</option>
                        <option value="Others">Others</option>
                    </select>
                </div>
                <div class="input-group">
                    <label for="vendor">Vendor</label>
                    <input type="text" id="vendor" placeholder="Enter vendor name">
                </div>
                <div class="input-group">
                    <label for="amount">Amount (₹)</label>
                    <input type="number" id="amount" placeholder="Enter amount">
                </div>
                <div class="input-group">
                    <label for="note">Note</label>
                    <textarea id="note" rows="3" placeholder="Add a note (optional)"></textarea>
                </div>
                <button class="btn btn-secondary" id="addExpenseBtn" onclick="addExpense(event)">Add Expense</button>
            </div>

            <div class="card full-width">
                <h2><span class="icon">📋</span> Recent Expenses</h2>
                <div id="recentExpenses"></div>
            </div>
        </div>

        <div id="summaryTab" class="tab-content">
            <div class="card full-width">
                <h2><span class="icon">📊</span> Spending by Category</h2>
                <div class="chart-container"><canvas id="categoryPieChart"></canvas></div>
            </div>
            <div class="stats-grid">
                <div class="card">
                    <h2><span class="icon">📈</span> Monthly Spending</h2>
                    <div class="chart-container"><canvas id="monthlyBarChart"></canvas></div>
                </div>
                <div class="card">
                    <h2><span class="icon">📉</span> Weekly Spending (Current Month)</h2>
                    <div class="chart-container"><canvas id="weeklyBarChart"></canvas></div>
                </div>
            </div>
            <div class="card full-width">
                <h2><span class="icon">🔢</span> Number of Spends by Category</h2>
                <div class="chart-container"><canvas id="categoryCountBarChart"></canvas></div>
            </div>
            <div class="card full-width">
                <h2><span class="icon">👥</span> Spending by User</h2>
                <div class="chart-container"><canvas id="userSpendingBarChart"></canvas></div>
            </div>
            <div class="summary-tables">
                <div class="card">
                    <h2><span class="icon">🏆</span> Top 3 Categories (by amount)</h2>
                    <div class="top-list-header">
                        <span style="flex:2;">Category</span>
                        <span style="flex:1; text-align:right;">Amount</span>
                        <span style="flex:1; text-align:right;">% of Total</span>
                    </div>
                    <ul id="topCategoriesList" class="top-list"></ul>
                </div>
                <div class="card">
                    <h2><span class="icon">🛍️</span> Top 3 Vendors (by amount)</h2>
                    <div class="top-list-header">
                        <span style="flex:2;">Vendor</span>
                        <span style="flex:1; text-align:right;">Amount</span>
                    </div>
                    <ul id="topVendorsList" class="top-list"></ul>
                </div>
            </div>
        </div>
        <div id="searchTab" class="tab-content">
            <div class="card full-width">
                <h2><span class="icon">🔍</span> Search Expenses</h2>
                <div class="input-group">
                    <label for="searchQuery">Search by Vendor, Category, Note or Owner</label>
                    <input type="text" id="searchQuery" placeholder="e.g., 'Grocery', 'Amazon', 'fuel', 'Akshay'">
                </div>
                <div class="download-buttons">
                    <button class="btn" id="searchBtn" onclick="performSearch()">Search</button>
                    <button class="btn btn-outline" id="clearSearchBtn" onclick="clearSearch()">Clear Search</button>
                </div>
                <div id="searchResultsDisplay" style="margin-top: 20px;"></div>
            </div>
        </div>
    </div>
    <!-- No delete modal, since removing receipts and keep code minimal. -->
    <script>
    // THEME
    function setTheme(theme) {
        document.documentElement.setAttribute('data-theme', theme);
        document.getElementById('themeToggleBtn').textContent = theme === 'dark' ? "☀️ Light" : "🌙 Dark";
    }
    function toggleTheme() {
        const curr = document.documentElement.getAttribute('data-theme');
        setTheme(curr === 'dark' ? 'light' : 'dark');
    }
    // Default: light
    setTheme('light');
    // --- Firebase Init
    const firebaseConfig = {
        apiKey: "AIzaSyCVcdGryuT",
        authDomain: "monthly-expense-tracke",
        databaseURL: "https://monthly-expense-trackcom",
        projectId: "monthly-expense",
        storageBucket: "monthly-exapp",
        messagingSenderId: "927",
        appId: "1:9276465869",
        measurementId: "G-9"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const fixedUserId = "public_expense_tracker_user";
    let budget = 0, expenses = [], filteredExpenses = [], currentSearchResults = [];
    // Chart instances
    let categoryPieChartInstance, monthlyBarChartInstance, weeklyBarChartInstance, userSpendingBarChartInstance, categoryCountBarChartInstance;
    document.addEventListener('DOMContentLoaded', () => {
        updateHeaderMonth();
        // Dates for filter/search not included here to keep code minimal.
        showTab('dashboardTab');
        Chart.register(ChartDataLabels);
        loadUserData();
    });
    function showTab(tabId) {
        const tabContents = document.querySelectorAll('.tab-content');
        tabContents.forEach(content => content.classList.remove('active'));
        const tabButtons = document.querySelectorAll('.tab-button');
        tabButtons.forEach(button => button.classList.remove('active'));
        document.getElementById(tabId).classList.add('active');
        document.querySelector(`.tab-button[onclick="showTab('${tabId}')"]`).classList.add('active');
        if (tabId === 'dashboardTab') {
            updateBudgetSummary(); updateBudgetProgressBar(); updateRecentExpenses();
        } else if (tabId === 'summaryTab') {
            renderCategoryPieChart(); renderMonthlyBarChart(); renderWeeklyBarChart();
            renderCategoryCountBarChart(); renderUserSpendingBarChart();
            updateTopCategories(); updateTopVendors();
        } else if (tabId === 'searchTab') {
            clearSearch();
        }
    }
    function loadUserData() {
        const uid = fixedUserId;
        db.collection('users').doc(uid).collection('budgets').doc('monthly')
            .onSnapshot((doc) => {
                if (doc.exists) { budget = doc.data().amount || 0; document.getElementById('budgetAmount').value = budget; }
                else { budget = 0; document.getElementById('budgetAmount').value = ''; }
                updateDisplay();
            }, (error) => { console.error("Error fetching budget:", error); });
        db.collection('users').doc(uid).collection('expenses').orderBy('date', 'desc').orderBy('time', 'desc')
            .onSnapshot((snapshot) => {
                expenses = [];
                snapshot.forEach((doc) => { expenses.push({ id: doc.id, ...doc.data() }); });
                expenses.sort((a, b) => {
                    const dateA = new Date(a.date + ' ' + a.time);
                    const dateB = new Date(b.date + ' ' + b.time);
                    return dateB - dateA;
                });
                updateDisplay();
            }, (error) => { console.error("Error fetching expenses:", error); });
    }
    async function setBudget(event) {
        const uid = fixedUserId;
        const budgetInput = document.getElementById('budgetAmount');
        const newBudget = parseFloat(budgetInput.value);
        const btn = event.target;
        const originalText = btn.textContent;
        if (isNaN(newBudget) || newBudget < 0) { alert('Please enter a valid budget amount (0 or greater)'); return; }
        try {
            await db.collection('users').doc(uid).collection('budgets').doc('monthly').set({ amount: newBudget });
            btn.textContent = '✅ Budget Set!'; setTimeout(() => { btn.textContent = originalText; }, 1200);
        } catch (e) { alert("Error setting budget: " + e.message); }
    }
    async function resetBudget() {
        const uid = fixedUserId;
        if (confirm('Are you sure you want to reset your budget to ₹0? This will not affect your expenses.')) {
            try { await db.collection('users').doc(uid).collection('budgets').doc('monthly').set({ amount: 0 }); }
            catch (e) { alert("Error resetting budget: " + e.message); }
        }
    }
    async function addExpense(event) {
        const uid = fixedUserId;
        const recordedBy = document.querySelector('input[name="recordedBy"]:checked').value;
        const category = document.getElementById('category').value;
        const vendor = document.getElementById('vendor').value.trim();
        const amount = parseFloat(document.getElementById('amount').value);
        const note = document.getElementById('note').value.trim();
        if (!category || !vendor || isNaN(amount) || amount <= 0) {
            alert('Please fill in all required fields: Category, Vendor, and a valid Amount.');
            return;
        }
        const btn = event.target; btn.disabled = true; btn.textContent = 'Adding...';
        const newExpense = {
            date: new Date().toISOString().split('T')[0],
            time: new Date().toLocaleTimeString('en-US', { hour12: false, hour: '2-digit', minute: '2-digit' }),
            category: category,
            vendor: vendor,
            amount: amount,
            note: note,
            recordedBy: recordedBy
        };
        try {
            await db.collection('users').doc(uid).collection('expenses').add(newExpense);
            document.getElementById('vendor').value = '';
            document.getElementById('amount').value = '';
            document.getElementById('note').value = '';
            alert('Expense added successfully!');
        } catch (e) { alert("Error adding expense: " + e.message); }
        finally { btn.disabled = false; btn.textContent = 'Add Expense'; }
    }
    function updateDisplay() { updateBudgetSummary(); updateBudgetProgressBar(); updateRecentExpenses(); }
    function updateBudgetSummary() {
        const totalSpent = expenses.reduce((sum, expense) => sum + expense.amount, 0);
        const remaining = budget - totalSpent;
        document.getElementById('budgetDisplay').textContent = `₹${budget.toLocaleString('en-IN')}`;
        document.getElementById('totalSpent').textContent = `₹${totalSpent.toLocaleString('en-IN')}`;
        document.getElementById('remaining').textContent = `₹${remaining.toLocaleString('en-IN')}`;
        const remainingElement = document.getElementById('remaining');
        remainingElement.style.color = remaining < 0 ? '#dc2626' : 'var(--text)';
    }
    function updateBudgetProgressBar() {
        const totalSpent = expenses.reduce((sum, expense) => sum + expense.amount, 0);
        const progressBarFill = document.getElementById('budgetProgressBarFill');
        const progressBarText = document.getElementById('budgetProgressBarText');
        let percentage = budget > 0 ? (totalSpent / budget) * 100 : 0;
        let displayPercentage = Math.min(percentage, 100);
        progressBarFill.style.width = `${displayPercentage}%`;
        let textColor = 'var(--text)', bgColor = 'linear-gradient(90deg, #9fe6b0, #7ee793)';
        if (percentage > 75 && percentage <= 100) bgColor = 'linear-gradient(90deg, #fbbf24, #f59e0b)';
        else if (percentage > 100) { bgColor = 'linear-gradient(90deg, #ef4444, #dc2626)'; textColor = '#fff'; }
        progressBarFill.style.background = bgColor;
        progressBarText.style.color = textColor;
        progressBarText.textContent = `${Math.round(percentage)}% Used`;
    }
    function updateRecentExpenses() {
        const recentExpensesDiv = document.getElementById('recentExpenses');
        recentExpensesDiv.innerHTML = '';
        if (expenses.length === 0) {
            recentExpensesDiv.innerHTML = '<p style="text-align: center; color: #6b7280; padding: 20px;">No recent expenses. Add one above!</p>';
            return;
        }
        const isMobile = window.innerWidth <= 768;
        if (isMobile) {
            const mobileCardContainer = document.createElement('div');
            mobileCardContainer.className = 'mobile-expense-card-container';
            expenses.slice(0, 10).forEach(expense => {
                const card = document.createElement('div');
                card.className = 'mobile-expense-card';
                card.innerHTML = `
                    <div class="mobile-expense-card-header">
                        <span class="category">${expense.category}</span>
                        <span class="amount">₹${expense.amount.toLocaleString('en-IN')}</span>
                    </div>
                    <div class="mobile-expense-card-body">
                        <div class="mobile-expense-card-field"><span class="label">Date:</span><span class="value">${expense.date}</span></div>
                        <div class="mobile-expense-card-field"><span class="label">Owner:</span><span class="value">${expense.recordedBy}</span></div>
                        <div class="mobile-expense-card-field"><span class="label">Vendor:</span><span class="value">${expense.vendor}</span></div>
                    </div>
                `;
                mobileCardContainer.appendChild(card);
            });
            recentExpensesDiv.appendChild(mobileCardContainer);
        } else {
            const tableContainer = document.createElement('div');
            tableContainer.className = 'table-container desktop-table-view';
            const table = document.createElement('table');
            table.innerHTML = `
                <thead>
                    <tr>
                        <th>Date</th>
                        <th>Owner</th>
                        <th>Category</th>
                        <th>Vendor</th>
                        <th>Amount (₹)</th>
                    </tr>
                </thead>
                <tbody id="recentExpensesTableBody"></tbody>
            `;
            tableContainer.appendChild(table);
            recentExpensesDiv.appendChild(tableContainer);
            const tableBody = document.getElementById('recentExpensesTableBody');
            expenses.slice(0, 10).forEach(expense => {
                const row = tableBody.insertRow();
                row.innerHTML = `
                    <td data-label="Date">${expense.date}</td>
                    <td data-label="Owner">${expense.recordedBy}</td>
                    <td data-label="Category">${expense.category}</td>
                    <td data-label="Vendor">${expense.vendor}</td>
                    <td data-label="Amount (₹)">₹${expense.amount.toLocaleString('en-IN')}</td>
                `;
            });
        }
    }
    // ---- CHARTS (with styling & titles removed) ----
    function renderCategoryPieChart() {
        if (categoryPieChartInstance) categoryPieChartInstance.destroy();
        const categorySpending = expenses.reduce((acc, expense) => {
            acc[expense.category] = (acc[expense.category] || 0) + expense.amount;
            return acc;
        }, {});
        const data = {
            labels: Object.keys(categorySpending),
            datasets: [{ data: Object.values(categorySpending),
                backgroundColor: ['#667eea', '#764ba2', '#38b2ac', '#ef4444', '#f97316', '#eab308', '#84cc16', '#22c55e', '#14b8a6', '#06b6d4', '#3b82f6', '#6366f1', '#a855f7', '#d946b6'],
                hoverOffset: 4 }]
        };
        const ctx = document.getElementById('categoryPieChart').getContext('2d');
        categoryPieChartInstance = new Chart(ctx, {
            type: 'pie',
            data: data,
            options: {
                responsive: true, maintainAspectRatio: false,
                plugins: {
                    legend: { position: 'right', labels: { font: { size: 11 }}},
                    tooltip: { callbacks: { label: function(context) {
                        let label = context.label || ''; if (label) { label += ': '; }
                        if (context.parsed !== null) { label += `₹${context.parsed.toLocaleString('en-IN')}`; }
                        return label;
                    }}},
                    datalabels: {
                        color: '#fff',
                        font: { weight: 'bold', size: 17 }, // LARGER label
                        formatter: (value, context) => {
                            const total = context.dataset.data.reduce((sum, current) => sum + current, 0);
                            const percentage = ((value / total) * 100).toFixed(1);
                            return percentage > 5 ? `${percentage}%` : '';
                        }
                    }
                }
            }
        });
    }
    function renderMonthlyBarChart() {
        if (monthlyBarChartInstance) monthlyBarChartInstance.destroy();
        // Last 12 months
        let now = new Date();
        let months = [];
        for(let i=11;i>=0;i--) {
            let d = new Date(now.getFullYear(), now.getMonth()-i, 1);
            months.push(d);
        }
        const labels = months.map(m=>m.toLocaleString('en-US', {month:'short', year:'2-digit'}));
        let monthlySpending = months.map((m, idx) => {
            const ym = m.getFullYear() + "-" + (m.getMonth()+1).toString().padStart(2,'0');
            return expenses.filter(exp=>exp.date.startsWith(ym)).reduce((sum,e)=>sum+e.amount,0);
        });
        const data = {
            labels: labels,
            datasets: [{
                label: 'Amount (₹)',
                data: monthlySpending,
                backgroundColor: '#667eea',
                borderColor: '#4f46e5',
                borderWidth: 1
            }]
        };
        const ctx = document.getElementById('monthlyBarChart').getContext('2d');
        monthlyBarChartInstance = new Chart(ctx, {
            type: 'bar',
            data: data,
            options: {
                responsive: true, maintainAspectRatio: false,
                plugins: {
                    legend: { display: false },
                    tooltip: { callbacks: { label: function(context) {
                        let label = context.dataset.label || ''; if (label) label += ': ';
                        if (context.parsed.y !== null) label += `₹${context.parsed.y.toLocaleString('en-IN')}`;
                        return label;
                    }}},
                    datalabels: { color: '#333', font: { weight: 'bold', size: 17 }, anchor: 'end', align: 'start',
                        formatter: (value)=> value>0?`₹${value}`:'' }
                },
                scales: {
                    x: { ticks: { font: { size: 11 } } },
                    y: { beginAtZero: true, title: {display: false}, ticks: {font: {size: 11}, callback: (value)=>'₹'+value}}
                }
            }
        });
    }
    function renderWeeklyBarChart() {
        if (weeklyBarChartInstance) weeklyBarChartInstance.destroy();
        // Split current month into 4 weeks: 1-7, 8-14, 15-21, 22-end
        let now = new Date(), year = now.getFullYear(), month = now.getMonth();
        let weeks = [
            { label: 'Week 1', start: 1, end: 7 },
            { label: 'Week 2', start: 8, end: 14 },
            { label: 'Week 3', start: 15, end: 21 },
            { label: 'Week 4', start: 22, end: new Date(year, month+1, 0).getDate() }
        ];
        let weeklySpending = weeks.map(w=>{
            return expenses.filter(exp => {
                let d = new Date(exp.date);
                return d.getFullYear()===year && d.getMonth()===month && (+exp.date.split('-')[2]>=w.start && +exp.date.split('-')[2]<=w.end);
            }).reduce((sum,e)=>sum+e.amount,0);
        });
        const ctx = document.getElementById('weeklyBarChart').getContext('2d');
        weeklyBarChartInstance = new Chart(ctx, {
            type: 'bar',
            data: { labels: weeks.map(w=>w.label), datasets: [{
                label: 'Amount (₹)', data: weeklySpending,
                backgroundColor: '#06b6d4', borderColor: '#0891b2', borderWidth: 1 }] },
            options: {
                responsive: true, maintainAspectRatio: false,
                plugins: {
                    legend: { display: false },
                    tooltip: { callbacks: { label: function(context) {
                        let label = context.dataset.label || ''; if (label) label += ': ';
                        if (context.parsed.y !== null) label += `₹${context.parsed.y.toLocaleString('en-IN')}`;
                        return label;
                    }}},
                    datalabels: { color: '#0891b2', font: { weight: 'bold', size: 17 }, anchor: 'end', align: 'start', formatter: (v)=>v>0?`₹${v}`:'' }
                },
                scales: {
                    x: { ticks: { font: { size: 11 } } },
                    y: { beginAtZero: true, title: {display: false}, ticks: {font: {size: 11}, callback: (value)=>'₹'+value}}
                }
            }
        });
    }
    function renderCategoryCountBarChart() {
        if (categoryCountBarChartInstance) categoryCountBarChartInstance.destroy();
        const categoryCounts = expenses.reduce((acc, expense) => {
            acc[expense.category] = (acc[expense.category] || 0) + 1;
            return acc;
        }, {});
        const ctx = document.getElementById('categoryCountBarChart').getContext('2d');
        categoryCountBarChartInstance = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: Object.keys(categoryCounts),
                datasets: [{
                    label: 'Number of Spends',
                    data: Object.values(categoryCounts),
                    backgroundColor: '#a855f7',
                    borderColor: '#9333ea',
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true, maintainAspectRatio: false,
                plugins: {
                    legend: { display: false },
                    tooltip: { callbacks: { label: function(context) {
                        let label = context.dataset.label || ''; if (label) label += ': ';
                        if (context.parsed.y !== null) label += `${context.parsed.y}`;
                        return label;
                    }}},
                    datalabels: { color: '#a855f7', font: { weight: 'bold', size: 17 }, anchor: 'end', align: 'start', formatter: (v)=>v>0?v:'' }
                },
                scales: {
                    x: { ticks: { font: { size: 11 } } },
                    y: { beginAtZero: true, title: {display: false}, ticks: {font: {size: 11}, precision:0}}
                }
            }
        });
    }
    function renderUserSpendingBarChart() {
        if (userSpendingBarChartInstance) userSpendingBarChartInstance.destroy();
        const userSpending = expenses.reduce((acc, expense) => {
            acc[expense.recordedBy] = (acc[expense.recordedBy] || 0) + expense.amount;
            return acc;
        }, {});
        const ctx = document.getElementById('userSpendingBarChart').getContext('2d');
        userSpendingBarChartInstance = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: Object.keys(userSpending),
                datasets: [{
                    label: 'Amount (₹)',
                    data: Object.values(userSpending),
                    backgroundColor: '#f59e0b',
                    borderColor: '#d97706',
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true, maintainAspectRatio: false,
                plugins: {
                    legend: { display: false },
                    tooltip: { callbacks: { label: function(context) {
                        let label = context.dataset.label || ''; if (label) label += ': ';
                        if (context.parsed.y !== null) label += `₹${context.parsed.y.toLocaleString('en-IN')}`;
                        return label;
                    }}},
                    datalabels: { color: '#d97706', font: { weight: 'bold', size: 17 }, anchor: 'end', align: 'start', formatter: (v)=>v>0?`₹${v}`:'' }
                },
                scales: {
                    x: { ticks: { font: { size: 11 } } },
                    y: { beginAtZero: true, title: {display: false}, ticks: {font: {size: 11}, callback: (value)=>'₹'+value}}
                }
            }
        });
    }
    // ---- Summary lists
    function updateTopCategories() {
        const topCategoriesList = document.getElementById('topCategoriesList');
        topCategoriesList.innerHTML = '';
        if (expenses.length === 0) {
            topCategoriesList.innerHTML = '<li><span class="label">No data available.</span></li>';
            return;
        }
        const categorySpending = expenses.reduce((acc, expense) => {
            acc[expense.category] = (acc[expense.category] || 0) + expense.amount;
            return acc;
        }, {});
        const totalSpending = expenses.reduce((sum, expense) => sum + expense.amount, 0);
        const sortedCategories = Object.entries(categorySpending).sort(([,a],[,b])=>b-a).slice(0,3);
        sortedCategories.forEach(([category, amount]) => {
            const percentage = totalSpending > 0 ? ((amount / totalSpending) * 100).toFixed(1) : 0;
            const li = document.createElement('li');
            li.innerHTML = `<span class="label">${category}</span><span class="value">₹${amount.toLocaleString('en-IN')}</span><span class="value">${percentage}%</span>`;
            topCategoriesList.appendChild(li);
        });
    }
    function updateTopVendors() {
        const topVendorsList = document.getElementById('topVendorsList');
        topVendorsList.innerHTML = '';
        if (expenses.length === 0) {
            topVendorsList.innerHTML = '<li><span class="label">No data available.</span></li>';
            return;
        }
        const vendorSpending = expenses.reduce((acc, expense) => {
            acc[expense.vendor] = (acc[expense.vendor] || 0) + expense.amount;
            return acc;
        }, {});
        const sortedVendors = Object.entries(vendorSpending).sort(([,a],[,b])=>b-a).slice(0,3);
        sortedVendors.forEach(([vendor, amount]) => {
            const li = document.createElement('li');
            li.innerHTML = `<span class="label">${vendor}</span><span class="value">₹${amount.toLocaleString('en-IN')}</span>`;
            topVendorsList.appendChild(li);
        });
    }
    // ---- Search (kept simple)
    function performSearch() {
        const searchQuery = document.getElementById('searchQuery').value.toLowerCase().trim();
        const searchResultsDisplay = document.getElementById('searchResultsDisplay');
        searchResultsDisplay.innerHTML = '';
        if (!searchQuery) {
            searchResultsDisplay.innerHTML = '<p style="text-align: center; color: #6b7280; padding: 20px;">Enter a search term to find expenses.</p>';
            currentSearchResults = [];
            return;
        }
        currentSearchResults = expenses.filter(expense =>
            expense.vendor.toLowerCase().includes(searchQuery) ||
            expense.category.toLowerCase().includes(searchQuery) ||
            expense.note.toLowerCase().includes(searchQuery) ||
            expense.recordedBy.toLowerCase().includes(searchQuery)
        );
        // Display as table (same columns as recent expenses)
        if (currentSearchResults.length === 0) {
            searchResultsDisplay.innerHTML = '<p style="text-align: center; color: #6b7280; padding: 20px;">No matching expenses found.</p>';
            return;
        }
        const tableContainer = document.createElement('div');
        tableContainer.className = 'table-container desktop-table-view';
        const table = document.createElement('table');
        table.innerHTML = `
            <thead>
                <tr>
                    <th>Date</th>
                    <th>Owner</th>
                    <th>Category</th>
                    <th>Vendor</th>
                    <th>Amount (₹)</th>
                </tr>
            </thead>
            <tbody id="searchResultsTableBody"></tbody>
        `;
        tableContainer.appendChild(table);
        searchResultsDisplay.appendChild(tableContainer);
        const tableBody = document.getElementById('searchResultsTableBody');
        currentSearchResults.forEach(expense => {
            const row = tableBody.insertRow();
            row.innerHTML = `
                <td data-label="Date">${expense.date}</td>
                <td data-label="Owner">${expense.recordedBy}</td>
                <td data-label="Category">${expense.category}</td>
                <td data-label="Vendor">${expense.vendor}</td>
                <td data-label="Amount (₹)">₹${expense.amount.toLocaleString('en-IN')}</td>
            `;
        });
    }
    function clearSearch() {
        document.getElementById('searchQuery').value = '';
        document.getElementById('searchResultsDisplay').innerHTML = '<p style="text-align: center; color: #6b7280; padding: 20px;">No search results.</p>';
        currentSearchResults = [];
    }
    function updateHeaderMonth() {
        const now = new Date();
        const monthNames = ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"];
        const currentMonthName = monthNames[now.getMonth()];
        const currentYear = now.getFullYear();
        document.getElementById('currentMonthYear').textContent = `${currentMonthName} ${currentYear}`;
    }
    </script>
</body>
</html>
