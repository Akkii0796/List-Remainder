<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Expense Tracker</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #a7b8fa 0%, #c4a9ef 100%); /* Lighter background */
            min-height: 100vh;
            padding: 10px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            backdrop-filter: blur(10px);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            overflow: hidden;
            animation: slideUp 0.5s ease-out;
            padding-top: 20px; /* Added padding for header spacing */
            padding-bottom: 20px; /* Added padding for bottom spacing */
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        header {
            background: linear-gradient(90deg, #6a82fb 0%, #fc5c7d 100%); /* Vibrant gradient */
            color: white;
            padding: 15px 20px;
            text-align: center;
            border-bottom: 5px solid rgba(0, 0, 0, 0.1);
            position: relative;
            z-index: 10;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.15);
        }

        header h1 {
            font-size: 2.2em;
            margin-bottom: 5px;
            letter-spacing: 1px;
        }

        .tab-navigation {
            display: flex;
            justify-content: space-around;
            background-color: #f0f0f0;
            border-bottom: 1px solid #ddd;
        }

        .tab-button {
            flex-grow: 1;
            padding: 15px 0;
            text-align: center;
            cursor: pointer;
            font-weight: bold;
            color: #555;
            transition: background-color 0.3s ease, color 0.3s ease;
            position: relative;
        }

        .tab-button.active {
            color: #6a82fb;
            background-color: #e8e8e8;
        }

        .tab-button.active::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 3px;
            background-color: #6a82fb;
            animation: tabUnderline 0.3s ease-out forwards;
        }

        @keyframes tabUnderline {
            from {
                transform: scaleX(0);
            }
            to {
                transform: scaleX(1);
            }
        }

        .tab-content {
            padding: 20px;
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .card {
            background-color: #fff;
            border-radius: 15px;
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.08);
            padding: 25px;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 12px 25px rgba(0, 0, 0, 0.12);
        }

        .card h2 {
            font-size: 1.5em;
            color: #333;
            margin-bottom: 15px;
            border-bottom: 1px solid #eee;
            padding-bottom: 10px;
        }

        .budget-summary p {
            font-size: 1.1em;
            margin-bottom: 10px;
            color: #555;
        }

        .budget-summary span {
            font-weight: bold;
            color: #333;
        }

        .progress-bar-container {
            background-color: #e0e0e0;
            border-radius: 10px;
            height: 15px;
            margin-top: 15px;
            overflow: hidden;
        }

        .progress-bar {
            height: 100%;
            border-radius: 10px;
            width: 0;
            background-color: #6a82fb;
            transition: width 0.5s ease-in-out, background-color 0.5s ease-in-out;
        }

        .progress-bar.green { background-color: #4CAF50; } /* Green */
        .progress-bar.orange { background-color: #FFC107; } /* Orange */
        .progress-bar.red { background-color: #F44336; } /* Red */

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: #444;
        }

        .form-group input[type="number"],
        .form-group input[type="text"],
        .form-group input[type="date"],
        .form-group select,
        .form-group textarea {
            width: calc(100% - 20px);
            padding: 12px 10px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 1em;
            transition: border-color 0.3s ease, box-shadow 0.3s ease;
        }

        .form-group input[type="number"]:focus,
        .form-group input[type="text"]:focus,
        .form-group input[type="date"]:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            border-color: #6a82fb;
            box-shadow: 0 0 0 3px rgba(106, 130, 251, 0.2);
            outline: none;
        }

        .radio-group label {
            margin-right: 15px;
            font-weight: normal;
        }

        .button-group {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        .button {
            padding: 12px 25px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1em;
            font-weight: bold;
            transition: background-color 0.3s ease, transform 0.2s ease, box-shadow 0.3s ease;
        }

        .button.primary {
            background-color: #6a82fb;
            color: white;
            box-shadow: 0 4px 10px rgba(106, 130, 251, 0.3);
        }

        .button.primary:hover {
            background-color: #5b70e1;
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(106, 130, 251, 0.4);
        }

        .button.secondary {
            background-color: #f0f0f0;
            color: #555;
            border: 1px solid #ddd;
        }

        .button.secondary:hover {
            background-color: #e0e0e0;
            transform: translateY(-2px);
        }

        .recent-expenses-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }

        .recent-expenses-table th,
        .recent-expenses-table td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid #eee;
            font-size: 0.95em;
        }

        .recent-expenses-table th {
            background-color: #f8f8f8;
            font-weight: bold;
            color: #666;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .recent-expenses-table tr:hover {
            background-color: #f5f5f5;
        }

        .recent-expenses-table .action-buttons .button {
            padding: 6px 12px;
            font-size: 0.85em;
        }

        .no-expenses {
            text-align: center;
            color: #888;
            padding: 30px;
            font-size: 1.1em;
        }

        .chart-container {
            position: relative;
            margin-bottom: 30px;
            background-color: #fff;
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.08);
        }

        .chart-container h2 {
            margin-bottom: 20px;
            text-align: center;
            color: #333;
        }

        .chart-container canvas {
            max-height: 400px; /* Limit chart height */
        }

        .top-items-list {
            list-style: none;
            padding: 0;
        }

        .top-items-list li {
            padding: 10px 0;
            border-bottom: 1px dashed #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 1.1em;
            color: #555;
        }

        .top-items-list li:last-child {
            border-bottom: none;
        }

        .top-items-list li span:first-child {
            font-weight: bold;
            color: #333;
        }

        .search-results-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        .search-results-table th,
        .search-results-table td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid #eee;
            font-size: 0.95em;
        }

        .search-results-table th {
            background-color: #f8f8f8;
            font-weight: bold;
            color: #666;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .search-results-table tr:hover {
            background-color: #f5f5f5;
        }

        .search-results-table .action-buttons .button {
            padding: 6px 12px;
            font-size: 0.85em;
        }

        .pagination-controls {
            display: flex;
            justify-content: center;
            margin-top: 20px;
            gap: 10px;
        }

        .pagination-controls button {
            padding: 8px 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
            background-color: #fff;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .pagination-controls button:hover:not(:disabled) {
            background-color: #e0e0e0;
        }

        .pagination-controls button:disabled {
            background-color: #f8f8f8;
            color: #ccc;
            cursor: not-allowed;
        }

        .export-buttons {
            display: flex;
            gap: 10px;
            margin-top: 20px;
            justify-content: flex-end;
            flex-wrap: wrap; /* Allow wrapping on smaller screens */
        }
        .export-buttons .button {
            background-color: #28a745; /* Green for export */
            color: white;
        }
        .export-buttons .button:hover {
            background-color: #218838;
        }

        /* Responsive adjustments */
        @media (max-width: 768px) {
            .dashboard-grid {
                grid-template-columns: 1fr; /* Stack cards vertically */
            }

            .tab-button {
                padding: 12px 0;
                font-size: 0.9em;
            }

            .card {
                padding: 20px;
            }

            .form-group input,
            .form-group select,
            .form-group textarea {
                width: 100%;
            }

            .recent-expenses-table,
            .search-results-table {
                font-size: 0.85em; /* Smaller font for tables */
            }

            .recent-expenses-table th,
            .recent-expenses-table td,
            .search-results-table th,
            .search-results-table td {
                padding: 8px 10px; /* Smaller padding */
            }
            .recent-expenses-table thead, .search-results-table thead {
                display: none; /* Hide header on small screens */
            }
            .recent-expenses-table tr, .search-results-table tr {
                display: block;
                margin-bottom: 10px;
                border: 1px solid #eee;
                border-radius: 8px;
            }
            .recent-expenses-table td, .search-results-table td {
                display: block;
                text-align: right;
                border-bottom: 1px dashed #eee;
            }
            .recent-expenses-table td:last-child, .search-results-table td:last-child {
                border-bottom: none;
            }
            .recent-expenses-table td::before, .search-results-table td::before {
                content: attr(data-label);
                float: left;
                font-weight: bold;
                text-transform: uppercase;
                margin-right: 10px;
            }
            .export-buttons {
                justify-content: center;
                flex-direction: column;
                gap: 5px;
            }
            .export-buttons .button {
                width: 100%; /* Full width buttons */
            }
        }
    </style>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-storage-compat.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.7.0/dist/chart.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
</head>
<body>
    <div class="container">
        <header>
            <h1>Monthly Expense Tracker</h1>
            <p id="currentMonthYear"></p>
        </header>

        <nav class="tab-navigation">
            <div class="tab-button active" onclick="showTab('dashboard')">Dashboard</div>
            <div class="tab-button" onclick="showTab('summary')">Summary</div>
            <div class="tab-button" onclick="showTab('search')">Search & History</div>
        </nav>

        <div id="dashboard" class="tab-content active">
            <div class="dashboard-grid">
                <div class="card budget-summary">
                    <h2>Current Budget</h2>
                    <p>Total Budget: <span id="totalBudget">₹0</span></p>
                    <p>Total Spent: <span id="totalSpent">₹0</span></p>
                    <p>Remaining: <span id="remainingBudget">₹0</span></p>
                    <div class="progress-bar-container">
                        <div class="progress-bar" id="budgetProgressBar"></div>
                    </div>
                    <div class="button-group" style="margin-top: 25px;">
                        <input type="number" id="budgetInput" placeholder="Set New Monthly Budget" style="flex-grow: 1; margin-right: 10px;">
                        <button class="button primary" onclick="setBudget()">Set Budget</button>
                        <button class="button secondary" onclick="resetBudget()">Reset</button>
                    </div>
                </div>

                <div class="card add-expense-form">
                    <h2>Add New Expense</h2>
                    <div class="form-group">
                        <label>Recorded By:</label>
                        <div class="radio-group">
                            <input type="radio" id="recordedByAkshay" name="recordedBy" value="Akshay" checked>
                            <label for="recordedByAkshay">Akshay</label>
                            <input type="radio" id="recordedByAchal" name="recordedBy" value="Achal">
                            <label for="recordedByAchal">Achal</label>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="expenseCategory">Category:</label>
                        <select id="expenseCategory">
                            <option value="Grocery">Grocery</option>
                            <option value="Bills">Bills</option>
                            <option value="Travelling">Travelling</option>
                            <option value="Food">Food</option>
                            <option value="Medical">Medical</option>
                            <option value="EMI">EMI</option>
                            <option value="Investment">Investment</option>
                            <option value="Shopping">Shopping</option>
                            <option value="Entertainment">Entertainment</option>
                            <option value="Personal Care">Personal Care</option>
                            <option value="Education">Education</option>
                            <option value="Gifts/Donations">Gifts/Donations</option>
                            <option value="Home Maintenance">Home Maintenance</option>
                            <option value="Transportation">Transportation</option>
                            <option value="Utilities">Utilities</option>
                            <option value="Others">Others</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="expenseVendor">Vendor:</label>
                        <input type="text" id="expenseVendor" placeholder="e.g., Reliance Fresh">
                    </div>
                    <div class="form-group">
                        <label for="expenseAmount">Amount:</label>
                        <input type="number" id="expenseAmount" placeholder="e.g., 500" min="0">
                    </div>
                    <div class="form-group">
                        <label for="expenseNote">Note (Optional):</label>
                        <textarea id="expenseNote" rows="2" placeholder="e.g., Groceries for the week"></textarea>
                    </div>
                    <div class="form-group">
                        <label for="expenseDate">Date:</label>
                        <input type="date" id="expenseDate">
                    </div>
                    <div class="form-group">
                        <label for="receiptUpload">Upload Receipt (Optional - Max 1MB image):</label>
                        <input type="file" id="receiptUpload" accept="image/*">
                    </div>
                    <button class="button primary" id="addExpenseButton" onclick="addExpense()">Add Expense</button>
                </div>
            </div>

            <div class="card">
                <h2>Recent Expenses</h2>
                <table class="recent-expenses-table">
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Recorded By</th>
                            <th>Category</th>
                            <th>Vendor</th>
                            <th>Amount</th>
                            <th>Note</th>
                            <th>Receipt</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="recentExpensesTableBody">
                        </tbody>
                </table>
                <p id="noRecentExpensesMessage" class="no-expenses" style="display: none;">No recent expenses found.</p>
                <div class="pagination-controls">
                    <button id="prevPage" onclick="prevPage()" disabled>Previous</button>
                    <span id="pageInfo">Page 1</span>
                    <button id="nextPage" onclick="nextPage()" disabled>Next</button>
                </div>
                <div class="export-buttons">
                    <button class="button" onclick="downloadCSV()">Download All CSV</button>
                    <button class="button" onclick="downloadPDF()">Download All PDF</button>
                </div>
            </div>
        </div>

        <div id="summary" class="tab-content">
            <div class="dashboard-grid">
                <div class="card">
                    <div class="chart-container">
                        <h2>Spending by Category</h2>
                        <canvas id="categoryPieChart"></canvas>
                    </div>
                </div>
                <div class="card">
                    <div class="chart-container">
                        <h2>Monthly Spending Trend</h2>
                        <canvas id="monthlyBarChart"></canvas>
                    </div>
                </div>
                <div class="card">
                    <div class="chart-container">
                        <h2>Daily Spending (Current Month)</h2>
                        <canvas id="dailyLineChart"></canvas>
                    </div>
                </div>
                <div class="card">
                    <div class="chart-container">
                        <h2>Weekly Spending Trend</h2>
                        <canvas id="weeklyBarChart"></canvas>
                    </div>
                </div>
                <div class="card">
                    <div class="chart-container">
                        <h2>Number of Spends by Category</h2>
                        <canvas id="spendsByCategoryBarChart"></canvas>
                    </div>
                </div>
                <div class="card">
                    <div class="chart-container">
                        <h2>Spending by User</h2>
                        <canvas id="userSpendingBarChart"></canvas>
                    </div>
                </div>
            </div>

            <div class="dashboard-grid">
                <div class="card">
                    <h2>Top 3 Categories</h2>
                    <ul id="topCategoriesList" class="top-items-list">
                        <li class="no-expenses">No categories yet.</li>
                    </ul>
                </div>
                <div class="card">
                    <h2>Top 3 Vendors</h2>
                    <ul id="topVendorsList" class="top-items-list">
                        <li class="no-expenses">No vendors yet.</li>
                    </ul>
                </div>
            </div>
        </div>

        <div id="search" class="tab-content">
            <div class="card">
                <h2>Search Expenses</h2>
                <div class="form-group">
                    <label for="searchQuery">Search by Vendor, Category, Note, or User:</label>
                    <input type="text" id="searchQuery" placeholder="e.g., Groceries, Vodafone, Akshay">
                </div>
                <div class="form-group">
                    <label for="filterStartDate">Start Date:</label>
                    <input type="date" id="filterStartDate">
                </div>
                <div class="form-group">
                    <label for="filterEndDate">End Date:</label>
                    <input type="date" id="filterEndDate">
                </div>
                <div class="button-group">
                    <button class="button primary" onclick="performSearch()">Search</button>
                    <button class="button secondary" onclick="clearSearchFilters()">Clear Filters</button>
                </div>

                <h3 style="margin-top: 30px; margin-bottom: 15px; color: #333;">Search Results:</h3>
                <table class="search-results-table">
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Recorded By</th>
                            <th>Category</th>
                            <th>Vendor</th>
                            <th>Amount</th>
                            <th>Note</th>
                            <th>Receipt</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="searchResultsTableBody">
                        </tbody>
                </table>
                <p id="noSearchResultsMessage" class="no-expenses" style="display: none;">No expenses found matching your criteria.</p>
                <div class="export-buttons">
                    <button class="button" onclick="downloadFilteredCSV()">Download Filtered CSV</button>
                    <button class="button" onclick="downloadFilteredPDF()">Download Filtered PDF</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Your Firebase configuration
        const firebaseConfig = {
            apiKey: "YOUR_API_KEY",
            authDomain: "YOUR_AUTH_DOMAIN",
            projectId: "YOUR_PROJECT_ID",
            storageBucket: "YOUR_STORAGE_BUCKET",
            messagingSenderId: "YOUR_MESSAGING_SENDER_ID",
            appId: "YOUR_APP_ID"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const storage = firebase.storage();

        // Fixed User ID (for a public/shared tracker)
        const fixedUserId = "public_expense_tracker_user";

        let budget = 0;
        let expenses = [];
        let currentPage = 1;
        const expensesPerPage = 10;
        let filteredExpenses = []; // For search/filter results

        // Chart instances to destroy and re-render
        let categoryPieChartInstance;
        let monthlyBarChartInstance;
        let dailyLineChartInstance;
        let weeklyBarChartInstance;
        let spendsByCategoryBarChartInstance;
        let userSpendingBarChartInstance;

        document.addEventListener('DOMContentLoaded', () => {
            loadUserData();
            updateHeaderMonth();
            // Set current date for expenseDate input
            const today = new Date();
            const yyyy = today.getFullYear();
            const mm = String(today.getMonth() + 1).padStart(2, '0'); // Months start at 0!
            const dd = String(today.getDay()).padStart(2, '0'); // Use getDay for actual day
            const todayDateString = `${yyyy}-${mm}-${dd}`;
            document.getElementById('expenseDate').value = todayDateString;
        });


        // === Firebase Operations ===

        async function loadUserData() {
            // Fetch Budget
            db.collection("users").doc(fixedUserId).collection("budget").doc("monthly")
                .onSnapshot((doc) => {
                    if (doc.exists) {
                        budget = doc.data().amount || 0;
                        document.getElementById('budgetInput').value = budget;
                        updateDisplay();
                    } else {
                        budget = 0;
                        document.getElementById('budgetInput').value = '';
                        updateDisplay();
                    }
                }, (error) => {
                    console.error("Error fetching budget: ", error);
                    alert("Error fetching budget: " + error.message);
                });

            // Fetch Expenses
            db.collection("users").doc(fixedUserId).collection("expenses")
                .orderBy("timestamp", "desc") // Order by timestamp to get recent first
                .onSnapshot((snapshot) => {
                    expenses = [];
                    snapshot.forEach((doc) => {
                        expenses.push({ id: doc.id, ...doc.data() });
                    });
                    updateDisplay();
                    updateSummaryCharts(); // Update charts whenever expenses change
                    filterAndDisplayExpenses(); // Re-display search results if filtered
                }, (error) => {
                    console.error("Error fetching expenses: ", error);
                    alert("Error fetching expenses: " + error.message);
                });
        }

        async function setBudget() {
            const newBudget = parseFloat(document.getElementById('budgetInput').value);
            if (isNaN(newBudget) || newBudget < 0) {
                alert("Please enter a valid positive number for the budget.");
                return;
            }
            try {
                await db.collection("users").doc(fixedUserId).collection("budget").doc("monthly").set({
                    amount: newBudget,
                    lastUpdated: firebase.firestore.FieldValue.serverTimestamp()
                });
                alert("Budget set successfully!");
            } catch (error) {
                console.error("Error setting budget: ", error);
                alert("Error setting budget: " + error.message);
            }
        }

        async function resetBudget() {
            if (confirm("Are you sure you want to reset your monthly budget to 0?")) {
                try {
                    await db.collection("users").doc(fixedUserId).collection("budget").doc("monthly").set({
                        amount: 0,
                        lastUpdated: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    alert("Budget reset successfully!");
                } catch (error) {
                    console.error("Error resetting budget: ", error);
                    alert("Error resetting budget: " + error.message);
                }
            }
        }

        async function addExpense() {
            const recordedBy = document.querySelector('input[name="recordedBy"]:checked').value;
            const category = document.getElementById('expenseCategory').value;
            const vendor = document.getElementById('expenseVendor').value.trim();
            const amount = parseFloat(document.getElementById('expenseAmount').value);
            const note = document.getElementById('expenseNote').value.trim();
            const expenseDate = document.getElementById('expenseDate').value;
            const receiptFile = document.getElementById('receiptUpload').files[0];

            if (!vendor || isNaN(amount) || amount <= 0 || !expenseDate) {
                alert("Please fill in Vendor, Amount (must be positive), and Date.");
                return;
            }

            const addExpenseButton = document.getElementById('addExpenseButton');
            addExpenseButton.textContent = 'Adding...';
            addExpenseButton.disabled = true;

            let receiptUrl = '';
            let filePath = '';

            try {
                if (receiptFile) {
                    if (receiptFile.size > 1 * 1024 * 1024) { // 1MB limit
                        alert("Receipt file size must be less than 1MB.");
                        addExpenseButton.textContent = 'Add Expense'; // Reset button text
                        addExpenseButton.disabled = false; // Re-enable button
                        return;
                    }
                    filePath = `receipts/${fixedUserId}/${Date.now()}_${receiptFile.name}`;
                    const storageRef = storage.ref(filePath);
                    const snapshot = await storageRef.put(receiptFile);
                    receiptUrl = await snapshot.ref.getDownloadURL();
                }

                await db.collection("users").doc(fixedUserId).collection("expenses").add({
                    recordedBy,
                    category,
                    vendor,
                    amount,
                    note,
                    date: expenseDate,
                    timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                    receiptUrl,
                    filePath // Store file path to delete later if needed
                });

                alert("Expense added successfully!");
                // Clear form
                document.getElementById('expenseVendor').value = '';
                document.getElementById('expenseAmount').value = '';
                document.getElementById('expenseNote').value = '';
                document.getElementById('receiptUpload').value = ''; // Clear file input
                document.getElementById('expenseDate').value = new Date().toISOString().split('T')[0]; // Reset date to today

                addExpenseButton.textContent = 'Add Expense'; // Reset button text
                addExpenseButton.disabled = false; // Re-enable button

            } catch (error) {
                console.error("Error adding expense: ", error);
                alert("Error adding expense: " + error.message);
                addExpenseButton.textContent = 'Add Expense'; // Reset button text
                addExpenseButton.disabled = false; // Re-enable button
            }
        }


        async function deleteExpense(expenseId, filePath) {
            if (confirm("Are you sure you want to delete this expense?")) {
                try {
                    // Delete expense from Firestore
                    await db.collection("users").doc(fixedUserId).collection("expenses").doc(expenseId).delete();

                    // If there's an associated receipt, delete it from Storage
                    if (filePath) {
                        const storageRef = storage.ref(filePath);
                        await storageRef.delete().catch((error) => {
                            // Ignore if file doesn't exist, log other errors
                            if (error.code !== 'storage/object-not-found') {
                                console.error("Error deleting receipt image from storage: ", error);
                            }
                        });
                    }
                    alert("Expense deleted successfully!");
                } catch (error) {
                    console.error("Error deleting expense: ", error);
                    alert("Error deleting expense: " + error.message);
                }
            }
        }


        // === UI Updates ===

        function updateDisplay() {
            updateBudgetSummary();
            updateBudgetProgressBar();
            updateRecentExpenses();
            updateTopCategories();
            updateTopVendors();
            // Charts are updated by updateSummaryCharts when expenses change
        }

        function updateBudgetSummary() {
            const totalSpent = expenses.reduce((sum, expense) => sum + expense.amount, 0);
            const remaining = budget - totalSpent;

            document.getElementById('totalBudget').textContent = `₹${budget.toLocaleString('en-IN')}`;
            document.getElementById('totalSpent').textContent = `₹${totalSpent.toLocaleString('en-IN')}`;
            document.getElementById('remainingBudget').textContent = `₹${remaining.toLocaleString('en-IN')}`;

            document.getElementById('remainingBudget').style.color = remaining >= 0 ? 'green' : 'red';
        }

        function updateBudgetProgressBar() {
            const totalSpent = expenses.reduce((sum, expense) => sum + expense.amount, 0);
            let percentage = (totalSpent / budget) * 100;
            if (isNaN(percentage) || !isFinite(percentage)) percentage = 0; // Handle division by zero

            const progressBar = document.getElementById('budgetProgressBar');
            progressBar.style.width = `${Math.min(percentage, 100)}%`; // Cap at 100% display

            progressBar.classList.remove('green', 'orange', 'red');
            if (percentage < 70) {
                progressBar.classList.add('green');
            } else if (percentage < 90) {
                progressBar.classList.add('orange');
            } else {
                progressBar.classList.add('red');
            }
        }

        function updateRecentExpenses() {
            const tableBody = document.getElementById('recentExpensesTableBody');
            tableBody.innerHTML = ''; // Clear existing rows

            const noExpensesMessage = document.getElementById('noRecentExpensesMessage');
            if (expenses.length === 0) {
                noExpensesMessage.style.display = 'block';
                document.getElementById('prevPage').disabled = true;
                document.getElementById('nextPage').disabled = true;
                document.getElementById('pageInfo').textContent = 'Page 0 of 0';
                return;
            } else {
                noExpensesMessage.style.display = 'none';
            }

            const totalPages = Math.ceil(expenses.length / expensesPerPage);
            currentPage = Math.min(currentPage, totalPages); // Ensure current page is not out of bounds
            currentPage = Math.max(currentPage, 1); // Ensure current page is at least 1

            const startIndex = (currentPage - 1) * expensesPerPage;
            const endIndex = Math.min(startIndex + expensesPerPage, expenses.length);
            const expensesToDisplay = expenses.slice(startIndex, endIndex);

            expensesToDisplay.forEach(expense => {
                const row = tableBody.insertRow();
                row.innerHTML = `
                    <td data-label="Date">${expense.date}</td>
                    <td data-label="Recorded By">${expense.recordedBy}</td>
                    <td data-label="Category">${expense.category}</td>
                    <td data-label="Vendor">${expense.vendor}</td>
                    <td data-label="Amount">₹${expense.amount.toLocaleString('en-IN')}</td>
                    <td data-label="Note">${expense.note || '-'}</td>
                    <td data-label="Receipt">
                        ${expense.receiptUrl ? `<a href="${expense.receiptUrl}" target="_blank">View</a>` : '-'}
                    </td>
                    <td data-label="Actions" class="action-buttons">
                        <button class="button secondary" onclick="deleteExpense('${expense.id}', '${expense.filePath || ''}')">Delete</button>
                    </td>
                `;
            });

            document.getElementById('pageInfo').textContent = `Page ${currentPage} of ${totalPages}`;
            document.getElementById('prevPage').disabled = currentPage === 1;
            document.getElementById('nextPage').disabled = currentPage === totalPages;
        }

        function nextPage() {
            const totalPages = Math.ceil(expenses.length / expensesPerPage);
            if (currentPage < totalPages) {
                currentPage++;
                updateRecentExpenses();
            }
        }

        function prevPage() {
            if (currentPage > 1) {
                currentPage--;
                updateRecentExpenses();
            }
        }

        function updateTopCategories() {
            const categorySums = expenses.reduce((acc, expense) => {
                acc[expense.category] = (acc[expense.category] || 0) + expense.amount;
                return acc;
            }, {});

            const sortedCategories = Object.entries(categorySums).sort(([, a], [, b]) => b - a);
            const topCategoriesList = document.getElementById('topCategoriesList');
            topCategoriesList.innerHTML = ''; // Clear existing

            if (sortedCategories.length === 0) {
                topCategoriesList.innerHTML = '<li class="no-expenses">No categories yet.</li>';
                return;
            }

            sortedCategories.slice(0, 3).forEach(([category, amount]) => {
                const li = document.createElement('li');
                li.innerHTML = `<span>${category}</span> <span>₹${amount.toLocaleString('en-IN')}</span>`;
                topCategoriesList.appendChild(li);
            });
        }

        function updateTopVendors() {
            const vendorSums = expenses.reduce((acc, expense) => {
                acc[expense.vendor] = (acc[expense.vendor] || 0) + expense.amount;
                return acc;
            }, {});

            const sortedVendors = Object.entries(vendorSums).sort(([, a], [, b]) => b - a);
            const topVendorsList = document.getElementById('topVendorsList');
            topVendorsList.innerHTML = ''; // Clear existing

            if (sortedVendors.length === 0) {
                topVendorsList.innerHTML = '<li class="no-expenses">No vendors yet.</li>';
                return;
            }

            sortedVendors.slice(0, 3).forEach(([vendor, amount]) => {
                const li = document.createElement('li');
                li.innerHTML = `<span>${vendor}</span> <span>₹${amount.toLocaleString('en-IN')}</span>`;
                topVendorsList.appendChild(li);
            });
        }


        // === Charting Functions ===
        function updateSummaryCharts() {
            // Destroy existing charts to prevent memory leaks and render issues
            if (categoryPieChartInstance) categoryPieChartInstance.destroy();
            if (monthlyBarChartInstance) monthlyBarChartInstance.destroy();
            if (dailyLineChartInstance) dailyLineChartInstance.destroy();
            if (weeklyBarChartInstance) weeklyBarChartInstance.destroy();
            if (spendsByCategoryBarChartInstance) spendsByCategoryBarChartInstance.destroy();
            if (userSpendingBarChartInstance) userSpendingBarChartInstance.destroy();

            // Render all charts
            renderCategoryPieChart();
            renderMonthlyBarChart();
            renderDailyLineChart();
            renderWeeklyBarChart();
            renderSpendsByCategoryBarChart();
            renderUserSpendingBarChart();
        }


        function renderCategoryPieChart() {
            const ctx = document.getElementById('categoryPieChart').getContext('2d');
            const categoryData = expenses.reduce((acc, expense) => {
                acc[expense.category] = (acc[expense.category] || 0) + expense.amount;
                return acc;
            }, {});

            const labels = Object.keys(categoryData);
            const data = Object.values(categoryData);
            const backgroundColors = labels.map((_, i) => `hsl(${i * 60}, 70%, 60%)`); // Dynamic colors

            if (labels.length === 0) {
                ctx.clearRect(0, 0, ctx.canvas.width, ctx.canvas.height);
                return;
            }

            categoryPieChartInstance = new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: labels,
                    datasets: [{
                        data: data,
                        backgroundColor: backgroundColors,
                        hoverOffset: 10
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'right',
                            labels: {
                                font: {
                                    size: 14
                                }
                            }
                        },
                        title: {
                            display: true,
                            text: 'Spending by Category',
                            font: {
                                size: 18
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    let label = context.label || '';
                                    if (label) {
                                        label += ': ';
                                    }
                                    if (context.parsed !== null) {
                                        label += '₹' + context.parsed.toLocaleString('en-IN');
                                    }
                                    return label;
                                }
                            }
                        },
                        datalabels: {
                            formatter: (value, ctx) => {
                                let sum = 0;
                                let dataArr = ctx.chart.data.datasets[0].data;
                                dataArr.map(data => {
                                    sum += data;
                                });
                                let percentage = (value * 100 / sum).toFixed(1) + "%";
                                return percentage;
                            },
                            color: '#fff',
                            font: {
                                weight: 'bold'
                            }
                        }
                    }
                },
                plugins: [ChartDataLabels]
            });
        }

        function renderMonthlyBarChart() {
            const ctx = document.getElementById('monthlyBarChart').getContext('2d');
            const monthlyData = expenses.reduce((acc, expense) => {
                const date = new Date(expense.date);
                const monthYear = `${date.toLocaleString('default', { month: 'short' })} ${date.getFullYear()}`;
                acc[monthYear] = (acc[monthYear] || 0) + expense.amount;
                return acc;
            }, {});

            // Sort months chronologically
            const sortedMonthYears = Object.keys(monthlyData).sort((a, b) => {
                const [monthA, yearA] = a.split(' ');
                const [monthB, yearB] = b.split(' ');
                const dateA = new Date(`${monthA} 1, ${yearA}`);
                const dateB = new Date(`${monthB} 1, ${yearB}`);
                return dateA - dateB;
            });

            const data = sortedMonthYears.map(my => monthlyData[my]);

            if (sortedMonthYears.length === 0) {
                ctx.clearRect(0, 0, ctx.canvas.width, ctx.canvas.height);
                return;
            }

            monthlyBarChartInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: sortedMonthYears,
                    datasets: [{
                        label: 'Amount (₹)',
                        data: data,
                        backgroundColor: 'rgba(75, 192, 192, 0.8)',
                        borderColor: 'rgba(75, 192, 192, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        },
                        title: {
                            display: true,
                            text: 'Monthly Spending Trend',
                            font: {
                                size: 18
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    let label = context.dataset.label || '';
                                    if (context.parsed.y !== null) {
                                        label += '₹' + context.parsed.y.toLocaleString('en-IN');
                                    }
                                    return label;
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Amount (₹)'
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'Month'
                            }
                        }
                    }
                }
            });
        }

        function renderDailyLineChart() {
            const ctx = document.getElementById('dailyLineChart').getContext('2d');
            const today = new Date();
            const currentMonth = today.getMonth();
            const currentYear = today.getFullYear();

            const dailyData = {};
            // Initialize all days of the current month to 0
            const daysInMonth = new Date(currentYear, currentMonth + 1, 0).getDate();
            for (let i = 1; i <= daysInMonth; i++) {
                const day = String(i).padStart(2, '0');
                const dateKey = `${currentYear}-${String(currentMonth + 1).padStart(2, '0')}-${day}`;
                dailyData[dateKey] = 0;
            }

            expenses.forEach(expense => {
                const expenseDate = new Date(expense.date);
                if (expenseDate.getMonth() === currentMonth && expenseDate.getFullYear() === currentYear) {
                    const dateKey = expense.date; // already in YYYY-MM-DD format
                    dailyData[dateKey] = (dailyData[dateKey] || 0) + expense.amount;
                }
            });

            const labels = Object.keys(dailyData).sort(); // Sort dates
            const data = labels.map(date => dailyData[date]);

            if (labels.length === 0 || data.every(val => val === 0)) {
                ctx.clearRect(0, 0, ctx.canvas.width, ctx.canvas.height);
                return;
            }


            dailyLineChartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels.map(date => date.substring(8)), // Show only day for label
                    datasets: [{
                        label: 'Amount (₹)',
                        data: data,
                        fill: true,
                        backgroundColor: 'rgba(255, 99, 132, 0.2)',
                        borderColor: 'rgba(255, 99, 132, 1)',
                        tension: 0.3
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        },
                        title: {
                            display: true,
                            text: `Daily Spending for ${today.toLocaleString('default', { month: 'long' })} ${currentYear}`,
                            font: {
                                size: 18
                            }
                        },
                        tooltip: {
                            callbacks: {
                                title: function(context) {
                                    return `Day ${context[0].label}`; // Show full date in tooltip if desired
                                },
                                label: function(context) {
                                    let label = context.dataset.label || '';
                                    if (context.parsed.y !== null) {
                                        label += '₹' + context.parsed.y.toLocaleString('en-IN');
                                    }
                                    return label;
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Amount (₹)'
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'Day of Month'
                            }
                        }
                    }
                }
            });
        }

        function renderWeeklyBarChart() {
            const ctx = document.getElementById('weeklyBarChart').getContext('2d');
            const weeklyData = {};

            expenses.forEach(expense => {
                const date = new Date(expense.date);
                const day = date.getDate();
                const month = date.getMonth();
                const year = date.getFullYear();

                // Calculate week number (simple approximation)
                // This assumes weeks start on the 1st of the month, not necessarily ISO week numbers
                const firstDayOfMonth = new Date(year, month, 1).getDay(); // Day of week for 1st of month
                const dayOfMonth = date.getDate();
                const weekNumber = Math.ceil((dayOfMonth + firstDayOfMonth) / 7);
                const weekLabel = `Week ${weekNumber} (${date.toLocaleString('default', { month: 'short' })})`;

                weeklyData[weekLabel] = (weeklyData[weekLabel] || 0) + expense.amount;
            });

            // Sort labels for display (e.g., Week 1, Week 2, etc.)
            const sortedLabels = Object.keys(weeklyData).sort((a, b) => {
                const weekNumA = parseInt(a.match(/Week (\d+)/)[1]);
                const weekNumB = parseInt(b.match(/Week (\d+)/)[1]);
                const monthA = new Date(`${a.match(/\((.*?)\)/)[1]} 1, 2000`).getMonth();
                const monthB = new Date(`${b.match(/\((.*?)\)/)[1]} 1, 2000`).getMonth();
                if (monthA !== monthB) return monthA - monthB; // Sort by month first
                return weekNumA - weekNumB; // Then by week number
            });

            const data = sortedLabels.map(label => weeklyData[label]);

            if (sortedLabels.length === 0) {
                ctx.clearRect(0, 0, ctx.canvas.width, ctx.canvas.height);
                return;
            }

            weeklyBarChartInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: sortedLabels,
                    datasets: [{
                        label: 'Amount (₹)',
                        data: data,
                        backgroundColor: 'rgba(153, 102, 255, 0.8)',
                        borderColor: 'rgba(153, 102, 255, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        },
                        title: {
                            display: true,
                            text: 'Weekly Spending Trend',
                            font: {
                                size: 18
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    let label = context.dataset.label || '';
                                    if (context.parsed.y !== null) {
                                        label += '₹' + context.parsed.y.toLocaleString('en-IN');
                                    }
                                    return label;
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Amount (₹)'
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'Week'
                            }
                        }
                    }
                }
            });
        }

        function renderSpendsByCategoryBarChart() {
            const ctx = document.getElementById('spendsByCategoryBarChart').getContext('2d');
            const categoryCount = expenses.reduce((acc, expense) => {
                acc[expense.category] = (acc[expense.category] || 0) + 1;
                return acc;
            }, {});

            const labels = Object.keys(categoryCount);
            const data = Object.values(categoryCount);

            if (labels.length === 0) {
                ctx.clearRect(0, 0, ctx.canvas.width, ctx.canvas.height);
                return;
            }

            spendsByCategoryBarChartInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Number of Spends',
                        data: data,
                        backgroundColor: 'rgba(255, 206, 86, 0.8)',
                        borderColor: 'rgba(255, 206, 86, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        },
                        title: {
                            display: true,
                            text: 'Number of Spends by Category',
                            font: {
                                size: 18
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    let label = context.dataset.label || '';
                                    if (context.parsed.y !== null) {
                                        label += ': ' + context.parsed.y;
                                    }
                                    return label;
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            precision: 0, // Ensure integer ticks for count
                            title: {
                                display: true,
                                text: 'Number of Spends'
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'Category'
                            }
                        }
                    }
                }
            });
        }

        function renderUserSpendingBarChart() {
            const ctx = document.getElementById('userSpendingBarChart').getContext('2d');
            const userSpending = expenses.reduce((acc, expense) => {
                acc[expense.recordedBy] = (acc[expense.recordedBy] || 0) + expense.amount;
                return acc;
            }, {});

            const labels = Object.keys(userSpending);
            const data = Object.values(userSpending);

            if (labels.length === 0) {
                ctx.clearRect(0, 0, ctx.canvas.width, ctx.canvas.height);
                return;
            }

            userSpendingBarChartInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Amount (₹)',
                        data: data,
                        backgroundColor: ['rgba(54, 162, 235, 0.8)', 'rgba(255, 159, 64, 0.8)'], // Colors for Akshay/Achal
                        borderColor: ['rgba(54, 162, 235, 1)', 'rgba(255, 159, 64, 1)'],
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        },
                        title: {
                            display: true,
                            text: 'Spending by User',
                            font: {
                                size: 18
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    let label = context.dataset.label || '';
                                    if (context.parsed.y !== null) {
                                        label += '₹' + context.parsed.y.toLocaleString('en-IN');
                                    }
                                    return label;
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Amount (₹)'
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'User'
                            }
                        }
                    }
                }
            });
        }



        // === Search & Filter ===

        function performSearch() {
            filterAndDisplayExpenses();
        }

        function clearSearchFilters() {
            document.getElementById('searchQuery').value = '';
            document.getElementById('filterStartDate').value = '';
            document.getElementById('filterEndDate').value = '';
            filterAndDisplayExpenses(); // Re-display all expenses
        }

        function filterAndDisplayExpenses() {
            const searchQuery = document.getElementById('searchQuery').value.toLowerCase();
            const startDate = document.getElementById('filterStartDate').value;
            const endDate = document.getElementById('filterEndDate').value;

            filteredExpenses = expenses.filter(expense => {
                const matchesSearch =
                    (expense.vendor && expense.vendor.toLowerCase().includes(searchQuery)) ||
                    (expense.category && expense.category.toLowerCase().includes(searchQuery)) ||
                    (expense.note && expense.note.toLowerCase().includes(searchQuery)) ||
                    (expense.recordedBy && expense.recordedBy.toLowerCase().includes(searchQuery));

                let matchesDate = true;
                if (startDate) {
                    matchesDate = matchesDate && expense.date >= startDate;
                }
                if (endDate) {
                    matchesDate = matchesDate && expense.date <= endDate;
                }

                return matchesSearch && matchesDate;
            });

            const tableBody = document.getElementById('searchResultsTableBody');
            tableBody.innerHTML = ''; // Clear existing rows

            const noSearchResultsMessage = document.getElementById('noSearchResultsMessage');
            if (filteredExpenses.length === 0) {
                noSearchResultsMessage.style.display = 'block';
                return;
            } else {
                noSearchResultsMessage.style.display = 'none';
            }

            filteredExpenses.forEach(expense => {
                const row = tableBody.insertRow();
                row.innerHTML = `
                    <td data-label="Date">${expense.date}</td>
                    <td data-label="Recorded By">${expense.recordedBy}</td>
                    <td data-label="Category">${expense.category}</td>
                    <td data-label="Vendor">${expense.vendor}</td>
                    <td data-label="Amount">₹${expense.amount.toLocaleString('en-IN')}</td>
                    <td data-label="Note">${expense.note || '-'}</td>
                    <td data-label="Receipt">
                        ${expense.receiptUrl ? `<a href="${expense.receiptUrl}" target="_blank">View</a>` : '-'}
                    </td>
                    <td data-label="Actions" class="action-buttons">
                        <button class="button secondary" onclick="deleteExpense('${expense.id}', '${expense.filePath || ''}')">Delete</button>
                    </td>
                `;
            });
        }


        // === Tab Navigation ===

        function showTab(tabId) {
            const tabs = document.querySelectorAll('.tab-content');
            tabs.forEach(tab => tab.classList.remove('active'));

            const buttons = document.querySelectorAll('.tab-button');
            buttons.forEach(button => button.classList.remove('active'));

            document.getElementById(tabId).classList.add('active');
            document.querySelector(`.tab-button[onclick="showTab('${tabId}')"]`).classList.add('active');

            // Re-render charts when summary tab is shown to ensure correct sizing
            if (tabId === 'summary') {
                updateSummaryCharts();
            } else if (tabId === 'search') {
                filterAndDisplayExpenses(); // Ensure search results are up to date
            }
        }


        // === Export Functions ===
        function convertTableDataToCSV(dataArray) {
            const header = ["Date", "Recorded By", "Category", "Vendor", "Amount", "Note", "Receipt URL"];
            const rows = dataArray.map(exp => [
                exp.date,
                exp.recordedBy,
                exp.category,
                exp.vendor,
                exp.amount,
                exp.note,
                exp.receiptUrl || ''
            ]);

            let csvContent = header.join(",") + "\n";
            rows.forEach(row => {
                csvContent += row.map(e => `"${String(e).replace(/"/g, '""')}"`).join(",") + "\n";
            });
            return csvContent;
        }

        function downloadCSV() {
            if (expenses.length === 0) {
                alert("No expenses to export.");
                return;
            }
            const csv = convertTableDataToCSV(expenses);
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");
            link.href = URL.createObjectURL(blob);
            link.setAttribute("download", "all_expenses.csv");
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        function downloadFilteredCSV() {
            if (filteredExpenses.length === 0) {
                alert("No filtered expenses to export.");
                return;
            }
            const csv = convertTableDataToCSV(filteredExpenses);
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");
            link.href = URL.createObjectURL(blob);
            const startDate = document.getElementById('filterStartDate').value;
            const endDate = document.getElementById('filterEndDate').value;
            link.setAttribute("download", `filtered_expenses_${startDate}_to_${endDate}.csv`);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        function downloadPDF() {
            if (expenses.length === 0) {
                alert("No expenses to export.");
                return;
            }
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();

            const tableColumn = ["Date", "By", "Category", "Vendor", "Amount (₹)", "Note"];
            const tableRows = [];

            expenses.forEach(expense => {
                const expenseData = [
                    expense.date,
                    expense.recordedBy,
                    expense.category,
                    expense.vendor,
                    expense.amount.toLocaleString('en-IN'),
                    expense.note || '-'
                ];
                tableRows.push(expenseData);
            });

            doc.autoTable({
                head: [tableColumn],
                body: tableRows,
                startY: 20,
                styles: { fontSize: 8, cellPadding: 2, overflow: 'linebreak' },
                headStyles: { fillColor: [106, 130, 251], textColor: 255 }, // Match header gradient color
                margin: { top: 15, right: 10, bottom: 10, left: 10 },
                didDrawPage: function(data) {
                    // Header
                    doc.setFontSize(12);
                    doc.setTextColor(40);
                    doc.text("All Expenses Report", data.settings.margin.left, 10);

                    // Footer
                    let str = "Page " + doc.internal.getNumberOfPages()
                    doc.setFontSize(8)
                    doc.text(str, data.settings.margin.left, doc.internal.pageSize.height - 10);
                }
            });

            doc.save("all_expenses.pdf");
        }

        function downloadFilteredPDF() {
            if (filteredExpenses.length === 0) {
                alert("No filtered expenses to export.");
                return;
            }
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();

            const tableColumn = ["Date", "By", "Category", "Vendor", "Amount (₹)", "Note"];
            const tableRows = [];

            filteredExpenses.forEach(expense => {
                const expenseData = [
                    expense.date,
                    expense.recordedBy,
                    expense.category,
                    expense.vendor,
                    expense.amount.toLocaleString('en-IN'),
                    expense.note || '-'
                ];
                tableRows.push(expenseData);
            });

            doc.autoTable({
                head: [tableColumn],
                body: tableRows,
                startY: 20,
                styles: { fontSize: 8, cellPadding: 2, overflow: 'linebreak' },
                headStyles: { fillColor: [102, 126, 234], textColor: 255 },
                margin: { top: 15, right: 10, bottom: 10, left: 10 },
                didDrawPage: function(data) {
                    // Header
                    doc.setFontSize(12);
                    doc.setTextColor(40);
                    const startDate = document.getElementById('filterStartDate').value;
                    const endDate = document.getElementById('filterEndDate').value;
                    doc.text(`Filtered Expenses Report (${startDate} to ${endDate})`, data.settings.margin.left, 10);

                    // Footer
                    let str = "Page " + doc.internal.getNumberOfPages()
                    doc.setFontSize(8)
                    doc.text(str, data.settings.margin.left, doc.internal.pageSize.height - 10);
                }
            });

            doc.save(`filtered_expenses_${document.getElementById('filterStartDate').value}_to_${document.getElementById('filterEndDate').value}.pdf`);
        }

        function updateHeaderMonth() {
            const now = new Date();
            const monthNames = ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"];
            const currentMonthName = monthNames[now.getMonth()];
            const currentYear = now.getFullYear();
            // Update the new paragraph element with month and year
            document.getElementById('currentMonthYear').textContent = `${currentMonthName} ${currentYear}`;
        }
    </script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
</body>
</html>
