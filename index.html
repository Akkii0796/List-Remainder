<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Expense Tracker</title>
    <!-- your existing styles… -->
    <style>
      /* … */
    </style>

    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <!-- ADDED: Storage SDK so firebase.storage() is defined :contentReference[oaicite:0]{index=0} -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-storage.js"></script>
    <!-- Chart.js plugins… -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
</head>
<body>
  <div class="container" id="appContent">
    <!-- your existing HTML… -->
    <div class="card">
      <h2><span class="icon">➕</span> Add Expense</h2>
      <div class="input-group">
        <label>Recorded By</label>
        <div class="radio-group">
          <label><input type="radio" name="recordedBy" value="Akshay" checked> Akshay</label>
          <label><input type="radio" name="recordedBy" value="Achal"> Achal</label>
        </div>
      </div>
      <div class="input-group">
        <label for="category">Category</label>
        <select id="category">
          <!-- …options… -->
        </select>
      </div>
      <div class="input-group">
        <label for="vendor">Vendor</label>
        <input type="text" id="vendor" placeholder="Enter vendor name">
      </div>
      <div class="input-group">
        <label for="amount">Amount (₹)</label>
        <input type="number" id="amount" placeholder="Enter amount">
      </div>
      <div class="input-group">
        <label for="note">Note</label>
        <textarea id="note" rows="3" placeholder="Add a note (optional)"></textarea>
      </div>
      <div class="input-group">
        <label for="receiptUpload">Upload Receipt (Optional)</label>
        <input type="file" id="receiptUpload" accept="image/*">
        <small style="color: #6b7280; font-size: 0.8em; margin-top: 5px; display: block;">
          Max 1MB for optimal performance. Larger files may not save.
        </small>
      </div>
      <button class="btn btn-secondary" id="addExpenseBtn" onclick="addExpense(event)">Add Expense</button>
    </div>
    <!-- …rest of your HTML… -->
  </div>

  <script>
    // Firebase Configuration
    const firebaseConfig = {
      apiKey: "AIzaSyCVcdGryuTGeMS2Aq9C2cqbeNmfnddDIu8",
      authDomain: "monthly-expense-tracker-179de.firebaseapp.com",
      databaseURL:
        "https://monthly-expense-tracker-179de-default-rtdb.firebaseio.com",
      projectId: "monthly-expense-tracker-179de",
      storageBucket: "monthly-expense-tracker-179de.firebasestorage.app",
      messagingSenderId: "927646586236",
      appId: "1:927646586236:web:fc56a0334a31464cf000f9",
      measurementId: "G-CVR339GKH9"
    };
    // Initialize Firebase
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const fixedUserId = "public_expense_tracker_user";

    // …all your other functions (loadUserData, updateDisplay, etc.)…

    // ——— ONLY ONE addExpense FUNCTION NOW ———
    async function addExpense(event) {
      const uid = fixedUserId;
      const recordedBy = document.querySelector('input[name="recordedBy"]:checked').value;
      const category = document.getElementById('category').value;
      const vendor = document.getElementById('vendor').value.trim();
      const amount = parseFloat(document.getElementById('amount').value);
      const note = document.getElementById('note').value.trim();
      const receiptFile = document.getElementById('receiptUpload').files[0];

      if (!category || !vendor || isNaN(amount) || amount <= 0) {
        alert('Please fill in all required fields: Category, Vendor, and Amount (must be greater than 0).');
        return;
      }

      const now = new Date();
      const date = now.toISOString().split('T')[0];
      const time = now.toTimeString().split(' ')[0];

      const expenseData = {
        recordedBy,
        category,
        vendor,
        amount,
        note,
        date,
        time,
        timestamp: firebase.firestore.FieldValue.serverTimestamp()
      };

      const btn = event.target;
      const originalText = btn.textContent;
      const originalBackground = btn.style.background;

      btn.textContent = 'Adding...';
      btn.disabled = true;

      try {
        if (receiptFile) {
          const storageRef = firebase.storage().ref();
          const receiptName = `receipts/${uid}/${Date.now()}_${receiptFile.name}`;
          const fileRef = storageRef.child(receiptName);

          if (receiptFile.size > 1 * 1024 * 1024) {
            alert('Receipt file is too large. Max size is 1MB.');
            btn.textContent = originalText;
            btn.disabled = false;
            return;
          }

          const snapshot = await fileRef.put(receiptFile);
          expenseData.receiptURL = await snapshot.ref.getDownloadURL();
        }

        await db.collection('users').doc(uid).collection('expenses').add(expenseData);

        btn.textContent = '✅ Added!';
        btn.style.background = 'linear-gradient(135deg, #9fe6b0, #7ee793)';

        // Clear form
        document.getElementById('vendor').value = '';
        document.getElementById('amount').value = '';
        document.getElementById('note').value = '';
        document.getElementById('receiptUpload').value = '';

        updateDisplay();
      } catch (e) {
        console.error("Error adding expense: ", e);
        alert("Error adding expense: " + e.message);
        btn.textContent = '❌ Failed!';
        btn.style.background = 'linear-gradient(135deg, #ef4444, #dc2626)';
      } finally {
        // Always re-enable after 2s
        setTimeout(() => {
          btn.textContent = originalText;
          btn.style.background = originalBackground;
          btn.disabled = false;
        }, 2000);
      }
    }
    // :contentReference[oaicite:1]{index=1}
  </script>

  <!-- jsPDF libs… -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
</body>
</html>
